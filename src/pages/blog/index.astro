---
import Base from '../../layouts/Base.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---
<Base title="Blog - The Slop Whisperer">
  <main>
    <h1>Blog</h1>
    <div class="filter-bar">
      <span class="filter-label">Filter:</span>
      <button class="filter-chip active" data-filter="all">all</button>
      <button class="filter-chip" data-filter="guide">guide</button>
      <button class="filter-chip" data-filter="manifesto">manifesto</button>
    </div>
    {posts.length === 0 ? (
      <p>Posts coming soon.</p>
    ) : (
      <ul class="post-list">
        {posts.map((post) => (
          <li data-tags={post.data.tags?.join(',') ?? ''}>
            <a href={`/blog/${post.id}/`}>
              <h2>{post.data.title}</h2>
              <p class="description">{post.data.description}</p>
              <time datetime={post.data.pubDate.toISOString()}>
                {post.data.pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
              </time>
            </a>
          </li>
        ))}
      </ul>
    )}
  </main>

  <script>
    const chips = document.querySelectorAll('.filter-chip');
    const items = document.querySelectorAll('.post-list li');

    function applyFilter(filter: string) {
      chips.forEach((c) => c.classList.remove('active'));
      const target = document.querySelector(`.filter-chip[data-filter="${filter}"]`);
      if (target) target.classList.add('active');

      if (filter === 'all') {
        items.forEach((item) => (item as HTMLElement).style.display = '');
        history.replaceState(null, '', location.pathname);
      } else {
        items.forEach((item) => {
          const tags = (item as HTMLElement).dataset.tags?.split(',') ?? [];
          (item as HTMLElement).style.display = tags.includes(filter) ? '' : 'none';
        });
        history.replaceState(null, '', `#${filter}`);
      }
    }

    chips.forEach((chip) => {
      chip.addEventListener('click', () => {
        const filter = chip.getAttribute('data-filter')!;
        const isActive = chip.classList.contains('active');

        // If clicking the already-active tag filter, reset to "all"
        if (isActive && filter !== 'all') {
          applyFilter('all');
          return;
        }

        applyFilter(filter);
      });
    });

    // Apply filter from URL hash on page load
    const hash = location.hash.slice(1);
    if (hash) {
      applyFilter(hash);
    }
  </script>

  <style>
    main {
      max-width: 640px;
      margin: 0 auto;
      padding: 2.5rem 1.5rem;
    }
    h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 1.5rem;
    }
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .filter-label {
      color: #666;
      font-size: 0.85rem;
    }
    .filter-chip {
      background: #1a1a1a;
      color: #888;
      border: 1px solid #1a1a1a;
      padding: 0.25rem 0.7rem;
      border-radius: 3px;
      font-size: 0.8rem;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
    }
    .filter-chip:hover {
      border-color: #333;
      color: #aaa;
    }
    .filter-chip.active {
      background: #8ab4f8;
      color: #0a0a0a;
      border-color: #8ab4f8;
    }
    .post-list {
      list-style: none;
    }
    .post-list li {
      margin-bottom: 2rem;
    }
    .post-list a {
      display: block;
      padding: 1.25rem;
      border: 1px solid #1a1a1a;
      border-radius: 6px;
      transition: border-color 0.15s;
    }
    .post-list a:hover {
      border-color: #333;
      text-decoration: none;
    }
    .post-list h2 {
      font-size: 1.3rem;
      color: #fff;
      margin-bottom: 0.4rem;
    }
    .description {
      color: #aaa;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }
    time {
      color: #666;
      font-size: 0.85rem;
    }
  </style>
</Base>
